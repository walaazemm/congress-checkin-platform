{% extends "base.html" %}
{% block title %}{{ p.full_name }} - Details{% endblock %}

{% block content %}
<style>
    .meal-status {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-weight: 500;
    }
    .meal-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px !important;
    }
</style>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2 class="page-title">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
        </svg>
        {{ p.full_name }}
    </h2>
    <a href="{% url 'checkin' %}" class="btn btn-info" style="display: inline-flex; align-items: center; gap: 6px;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
        New Scan
    </a>
</div>

<div class="card">
    <p><strong>Nationality:</strong> {{ p.nationality }}</p>
<p><strong>Payment Status:</strong> 
    {% if p.free_access %}
        <span style="font-weight: bold; color: #1976D2;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                <path d="M12 2v2"></path>
                <path d="M12 20v2"></path>
                <path d="M4.93 4.93l1.41 1.41"></path>
                <path d="M17.66 17.66l1.41 1.41"></path>
                <path d="M1 12h2"></path>
                <path d="M21 12h2"></path>
                <path d="M4.93 19.07l1.41-1.41"></path>
                <path d="M17.66 6.34l1.41-1.41"></path>
                <circle cx="12" cy="12" r="8"></circle>
            </svg>
            FREE ACCESS
        </span>
    {% elif p.paid %}
        <span style="font-weight: bold; color: #4CAF50;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            PAID
        </span>
    {% else %}
        <span style="font-weight: bold; color: #d32f2f;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                <path d="M18 6L6 18"></path>
                <path d="M6 6l12 12"></path>
            </svg>
            UNPAID
        </span>
    {% endif %}
</p><!-- Payment Toggle -->
{% if user.is_super_admin or user.is_checkin_admin %}
<div style="margin: 20px 0;">
    <form method="post" action="{% url 'toggle_payment' p.id %}">
        {% csrf_token %}
        {% if p.paid %}
            <!-- Currently PAID → next state is FREE -->
            <button type="submit" class="btn btn-warning">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18"></path>
                    <path d="M6 6l12 12"></path>
                </svg>
                Mark as FREE
            </button>
        {% elif p.free_access %}
            <!-- Currently FREE → next state is UNPAID -->
            <button type="submit" class="btn btn-danger">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18"></path>
                    <path d="M6 6l12 12"></path>
                </svg>
                Mark as UNPAID
            </button>
        {% else %}
            <!-- Currently UNPAID → next state is PAID -->
            <button type="submit" class="btn btn-success">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                Mark as PAID
            </button>
        {% endif %}
    </form>
</div>
{% endif %}

    <!-- Presence Toggle -->
    <div style="margin: 20px 0;">
        <form method="post" action="{% url 'toggle_presence' p.id %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn {% if p.is_present %}btn-success{% else %}btn-outline-secondary{% endif %}" style="display: inline-flex; align-items: center; gap: 8px;">
                {% if p.is_present %}
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Confirmed (Click to Undo)
                {% else %}
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8a3 3 0 0 0-3-3 3 3 0 0 0-3 3v4a3 3 0 0 0 3 3 3 3 0 0 0 3-3z"></path>
                        <path d="M6 12a3 3 0 0 0-3-3 3 3 0 0 0-3 3v4a3 3 0 0 0 3 3 3 3 0 0 0 3-3z"></path>
                    </svg>
                    Confirm Presence
                {% endif %}
            </button>
        </form>
    </div>

    <!-- Meals -->
    <h3 style="margin: 25px 0 15px; display: flex; align-items: center; gap: 10px;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 8a3 3 0 0 0-3-3 3 3 0 0 0-3 3v4a3 3 0 0 0 3 3 3 3 0 0 0 3-3z"></path>
            <path d="M6 12a3 3 0 0 0-3-3 3 3 0 0 0-3 3v4a3 3 0 0 0 3 3 3 3 0 0 0 3-3z"></path>
        </svg>
        Meals (5 Days)
    </h3>

    <!-- Day 1 -->
    <div style="margin-bottom: 15px; padding: 12px; background: #fafafa; border-radius: 8px;">
        <strong>Day 1 (Nov 3)</strong>
        <div style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">
            <form method="post" action="{% url 'toggle_meal' p.id 'breakfast_day1' %}">
                {% csrf_token %}
                <button type="submit" class="btn meal-btn" style="background: {% if p.breakfast_day1 %}#4CAF50{% else %}#e0e0e0{% endif %}; color: white;">
                    <span class="meal-status">
                        {% if p.breakfast_day1 %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        {% else %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                            </svg>
                        {% endif %}
                        Breakfast
                    </span>
                </button>
            </form>
            <form method="post" action="{% url 'toggle_meal' p.id 'lunch_day1' %}">
                {% csrf_token %}
                <button type="submit" class="btn meal-btn" style="background: {% if p.lunch_day1 %}#4CAF50{% else %}#e0e0e0{% endif %}; color: white;">
                    <span class="meal-status">
                        {% if p.lunch_day1 %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        {% else %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                            </svg>
                        {% endif %}
                        Lunch
                    </span>
                </button>
            </form>
        </div>
    </div>

    <!-- Day 2 -->
    <div style="margin-bottom: 15px; padding: 12px; background: #fafafa; border-radius: 8px;">
        <strong>Day 2 (Nov 4)</strong>
        <div style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">
            <form method="post" action="{% url 'toggle_meal' p.id 'breakfast_day2' %}">
                {% csrf_token %}
                <button type="submit" class="btn meal-btn" style="background: {% if p.breakfast_day2 %}#4CAF50{% else %}#e0e0e0{% endif %}; color: white;">
                    <span class="meal-status">
                        {% if p.breakfast_day2 %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        {% else %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                            </svg>
                        {% endif %}
                        Breakfast
                    </span>
                </button>
            </form>
            <form method="post" action="{% url 'toggle_meal' p.id 'lunch_day2' %}">
                {% csrf_token %}
                <button type="submit" class="btn meal-btn" style="background: {% if p.lunch_day2 %}#4CAF50{% else %}#e0e0e0{% endif %}; color: white;">
                    <span class="meal-status">
                        {% if p.lunch_day2 %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        {% else %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                            </svg>
                        {% endif %}
                        Lunch
                    </span>
                </button>
            </form>
        </div>
    </div>

    <!-- Day 3 -->
    <div style="margin-bottom: 15px; padding: 12px; background: #fafafa; border-radius: 8px;">
        <strong>Day 3 (Nov 5)</strong>
        <div style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">
            <form method="post" action="{% url 'toggle_meal' p.id 'breakfast_day3' %}">
                {% csrf_token %}
                <button type="submit" class="btn meal-btn" style="background: {% if p.breakfast_day3 %}#4CAF50{% else %}#e0e0e0{% endif %}; color: white;">
                    <span class="meal-status">
                        {% if p.breakfast_day3 %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        {% else %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                            </svg>
                        {% endif %}
                        Breakfast
                    </span>
                </button>
            </form>
            <form method="post" action="{% url 'toggle_meal' p.id 'lunch_day3' %}">
                {% csrf_token %}
                <button type="submit" class="btn meal-btn" style="background: {% if p.lunch_day3 %}#4CAF50{% else %}#e0e0e0{% endif %}; color: white;">
                    <span class="meal-status">
                        {% if p.lunch_day3 %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        {% else %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                            </svg>
                        {% endif %}
                        Lunch
                    </span>
                </button>
            </form>
        </div>
    </div>

    <!-- Day 4 -->
    <div style="margin-bottom: 15px; padding: 12px; background: #fafafa; border-radius: 8px;">
        <strong>Day 4 (Nov 6)</strong>
        <div style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">
            <form method="post" action="{% url 'toggle_meal' p.id 'breakfast_day4' %}">
                {% csrf_token %}
                <button type="submit" class="btn meal-btn" style="background: {% if p.breakfast_day4 %}#4CAF50{% else %}#e0e0e0{% endif %}; color: white;">
                    <span class="meal-status">
                        {% if p.breakfast_day4 %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        {% else %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                            </svg>
                        {% endif %}
                        Breakfast
                    </span>
                </button>
            </form>
            <form method="post" action="{% url 'toggle_meal' p.id 'lunch_day4' %}">
                {% csrf_token %}
                <button type="submit" class="btn meal-btn" style="background: {% if p.lunch_day4 %}#4CAF50{% else %}#e0e0e0{% endif %}; color: white;">
                    <span class="meal-status">
                        {% if p.lunch_day4 %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        {% else %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                            </svg>
                        {% endif %}
                        Lunch
                    </span>
                </button>
            </form>
        </div>
    </div>

    <!-- Day 5 -->
    <div style="margin-bottom: 15px; padding: 12px; background: #fafafa; border-radius: 8px;">
        <strong>Day 5 (Nov 7)</strong>
        <div style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">
            <form method="post" action="{% url 'toggle_meal' p.id 'breakfast_day5' %}">
                {% csrf_token %}
                <button type="submit" class="btn meal-btn" style="background: {% if p.breakfast_day5 %}#4CAF50{% else %}#e0e0e0{% endif %}; color: white;">
                    <span class="meal-status">
                        {% if p.breakfast_day5 %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        {% else %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                            </svg>
                        {% endif %}
                        Breakfast
                    </span>
                </button>
            </form>
            <form method="post" action="{% url 'toggle_meal' p.id 'lunch_day5' %}">
                {% csrf_token %}
                <button type="submit" class="btn meal-btn" style="background: {% if p.lunch_day5 %}#4CAF50{% else %}#e0e0e0{% endif %}; color: white;">
                    <span class="meal-status">
                        {% if p.lunch_day5 %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        {% else %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                            </svg>
                        {% endif %}
                        Lunch
                    </span>
                </button>
            </form>
        </div>
    </div>
</div>

{% if from_scan %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const audio = document.getElementById('success-sound');
    setTimeout(() => {
        audio.play().catch(e => console.log("Audio play blocked:", e));
    }, 200);
});
</script>
{% endif %}
{% endblock %}